<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maquette 05 — Ajouter une condition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwindcss.config = {
      theme: {
        extend: {
          colors: { primary: '#1e3a5f', accent: '#e07a2f' },
          fontFamily: { outfit: ['Outfit', 'system-ui', 'sans-serif'] },
        },
      },
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    .viewport-btn.active { background: #1e3a5f; color: white; }
    .viewport-frame { transition: width 0.4s ease, max-width 0.4s ease; margin: 0 auto; overflow: hidden; }
    .overlay {
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
      overflow-y: auto;
    }
    .modal-enter {
      animation: modalIn 0.2s ease-out;
      display: flex;
      flex-direction: column;
      max-height: calc(100% - 2rem);
    }
    .modal-body {
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(8px); } to { opacity: 1; transform: scale(1) translateY(0); } }

    /* Mobile bottom-sheet */
    .mobile-mode { overflow-y: auto !important; }
    .mobile-mode .overlay {
      align-items: flex-end;
      padding: 0;
    }
    .mobile-mode .modal-enter {
      max-width: 100%;
      border-radius: 1rem 1rem 0 0;
      max-height: 92%;
      animation: sheetUp 0.25s ease-out;
    }
    .mobile-mode .mobile-handle { display: flex; }
    .mobile-mode .modal-header { padding-top: 0.75rem; }
    @keyframes sheetUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }

    /* State toggle */
    .state-section { display: none; }
    .state-section.active { display: block; }
    .state-btn.active { background: #1e3a5f; color: white; }

    /* Level card selection */
    .level-card { cursor: pointer; transition: all 0.15s ease; }
    .level-card:hover { border-color: #1e3a5f; }
    .level-card.selected { border-color: #1e3a5f; background: rgba(30,58,95,0.05); box-shadow: 0 0 0 2px rgba(30,58,95,0.15); }
    .level-card .radio-dot { display: none; }
    .level-card.selected .radio-dot { display: block; }
    .level-card .radio-empty { display: block; }
    .level-card.selected .radio-empty { display: none; }

    /* Pack condition toggle */
    .pack-condition-row { transition: opacity 0.15s ease; }
    .pack-condition-row.excluded { opacity: 0.4; }
    .pack-condition-row.excluded .condition-name { text-decoration: line-through; }

    /* Tooltip */
    .tooltip-wrapper { position: relative; }
    .tooltip-wrapper .tooltip-text {
      visibility: hidden; opacity: 0; position: absolute; bottom: calc(100% + 6px); left: 50%;
      transform: translateX(-50%); background: #1e293b; color: white; padding: 4px 10px;
      border-radius: 6px; font-size: 11px; white-space: nowrap; transition: opacity 0.2s; z-index: 50;
    }
    .tooltip-wrapper:hover .tooltip-text { visibility: visible; opacity: 1; }
  </style>
</head>
<body class="bg-stone-200 min-h-screen">

  <!-- VIEWPORT SWITCHER -->
  <div class="fixed top-0 left-0 right-0 bg-stone-800 text-white z-[100] shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-sm font-bold font-outfit">MAQUETTE 05</span>
        <span class="text-xs text-stone-400">Ajouter une condition</span>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="setViewport('mobile')" id="btn-mobile" class="viewport-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-stone-700 hover:bg-stone-600 transition-colors">Mobile (375px)</button>
        <button onclick="setViewport('tablet')" id="btn-tablet" class="viewport-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-stone-700 hover:bg-stone-600 transition-colors">Tablette (768px)</button>
        <button onclick="setViewport('desktop')" id="btn-desktop" class="viewport-btn active px-3 py-1.5 rounded-lg text-xs font-medium bg-stone-700 hover:bg-stone-600 transition-colors">Desktop (1280px)</button>
      </div>
      <div class="text-xs text-stone-400">Bouton "+ Condition" / "Pack recommande"</div>
    </div>
  </div>

  <!-- STATE SWITCHER -->
  <div class="fixed top-[52px] left-0 right-0 bg-stone-700 text-white z-[99] border-t border-stone-600">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center gap-3">
      <span class="text-xs text-stone-400 font-medium">MODE :</span>
      <button onclick="showState('manual')" id="state-manual" class="state-btn active px-3 py-1 rounded-md text-xs font-medium bg-stone-600 hover:bg-stone-500 transition-colors">A — Ajout manuel</button>
      <button onclick="showState('pack')" id="state-pack" class="state-btn px-3 py-1 rounded-md text-xs font-medium bg-stone-600 hover:bg-stone-500 transition-colors">B — Pack recommande</button>
      <button onclick="showState('success')" id="state-success" class="state-btn px-3 py-1 rounded-md text-xs font-medium bg-stone-600 hover:bg-stone-500 transition-colors">C — Succes (pack)</button>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- ETAT A: AJOUT MANUEL                            -->
  <!-- ============================================== -->
  <div id="state-manual-section" class="state-section active pt-24 pb-8 px-4">
    <div id="viewport-frame-a" class="viewport-frame bg-stone-100 shadow-2xl rounded-xl border border-stone-300 relative" style="width: 100%; max-width: 1280px; height: 80vh;">

      <!-- Fond simule -->
      <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8">
        <div class="w-full max-w-4xl opacity-30">
          <div class="h-8 bg-stone-300 rounded mb-4 w-48"></div>
          <div class="h-4 bg-stone-200 rounded mb-2 w-64"></div>
          <div class="h-32 bg-stone-200 rounded mb-4"></div>
          <div class="h-48 bg-stone-200 rounded mb-4"></div>
          <div class="h-64 bg-stone-200 rounded"></div>
        </div>
      </div>

      <!-- OVERLAY -->
      <div class="overlay absolute inset-0 z-40 flex items-center justify-center p-4">
        <div class="modal-enter bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">

          <!-- Drag handle -->
          <div class="mobile-handle hidden justify-center pt-2 pb-1">
            <div class="w-10 h-1 rounded-full bg-stone-300"></div>
          </div>

          <!-- Header -->
          <div class="modal-header px-5 sm:px-6 pt-5 sm:pt-6 pb-4 border-b border-stone-100">
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center shrink-0">
                  <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                </div>
                <div>
                  <h2 class="text-base sm:text-lg font-bold text-stone-900 font-outfit">Ajouter une condition</h2>
                  <p class="text-xs text-stone-500 mt-0.5">Etape 4 — Periode conditionnelle</p>
                </div>
              </div>
              <button class="p-1.5 rounded-lg hover:bg-stone-100 text-stone-400 -mt-1 -mr-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>

          <!-- Corps -->
          <div class="modal-body px-5 sm:px-6 py-4 space-y-4">

            <!-- Info -->
            <div class="rounded-lg bg-primary/5 border border-primary/10 px-3 py-2 flex items-start gap-2">
              <svg class="w-4 h-4 text-primary mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <p class="text-xs text-primary/80">Ajout manuel — cette condition sera marquee <span class="inline-flex items-center px-1 py-0.5 rounded text-[10px] font-medium bg-violet-100 text-violet-700">Manuelle</span> dans le suivi.</p>
            </div>

            <!-- Nom de la condition -->
            <div>
              <label class="block text-xs font-semibold text-stone-600 mb-1.5 uppercase tracking-wide">Nom de la condition <span class="text-red-400">*</span></label>
              <input id="condition-name" type="text" placeholder="Ex : Verification de la toiture" class="w-full px-3 py-2.5 text-sm rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-primary/20" oninput="updateManualCta()">
            </div>

            <!-- Niveau -->
            <div>
              <label class="block text-xs font-semibold text-stone-600 mb-2 uppercase tracking-wide">Niveau <span class="text-red-400">*</span></label>
              <div class="space-y-2" id="level-cards">
                <!-- Bloquante -->
                <div class="level-card rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectLevel(this, 'blocking')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-medium text-stone-900">Bloquante</span>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-red-100 text-red-700">Bloquante</span>
                    </div>
                    <p class="text-xs text-stone-500 mt-0.5">Empeche la validation de l'etape tant qu'elle n'est pas resolue</p>
                  </div>
                </div>
                <!-- Requise -->
                <div class="level-card rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectLevel(this, 'required')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-medium text-stone-900">Requise</span>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-amber-100 text-amber-700">Requise</span>
                    </div>
                    <p class="text-xs text-stone-500 mt-0.5">Doit etre resolue, mais peut etre passee avec risque si necessaire</p>
                  </div>
                </div>
                <!-- Recommandee -->
                <div class="level-card rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectLevel(this, 'recommended')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-medium text-stone-900">Recommandee</span>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-stone-200 text-stone-600">Recommandee</span>
                    </div>
                    <p class="text-xs text-stone-500 mt-0.5">Bonne pratique — auto-archivee si non resolue a la validation</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Echeance -->
            <div>
              <label class="block text-xs font-semibold text-stone-600 mb-1.5 uppercase tracking-wide">Echeance</label>
              <input type="date" value="2026-02-25" class="w-full px-3 py-2.5 text-sm rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-primary/20">
              <p class="text-xs text-stone-400 mt-1">Par defaut : aligne sur l'echeance de l'etape</p>
            </div>

            <!-- Note -->
            <div>
              <label class="block text-xs font-medium text-stone-600 mb-1">Note (optionnel)</label>
              <textarea rows="2" placeholder="Ex : Demande par l'acheteur suite a l'inspection..." class="w-full px-3 py-2 text-sm rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-primary/20 resize-none"></textarea>
            </div>

          </div>

          <!-- Footer -->
          <div class="px-5 sm:px-6 py-4 bg-stone-50 border-t border-stone-100 flex flex-col-reverse sm:flex-row items-stretch sm:items-center gap-2 sm:justify-end">
            <button class="px-4 py-2.5 rounded-lg border border-stone-200 text-stone-600 hover:bg-stone-100 text-sm font-medium text-center">
              Annuler
            </button>
            <button id="cta-manual" disabled class="px-6 py-2.5 rounded-lg bg-stone-300 text-stone-500 text-sm font-semibold shadow-sm flex items-center justify-center gap-2 cursor-not-allowed" title="Nom et niveau requis">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              Ajouter la condition
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- ETAT B: CHARGER UN PACK RECOMMANDE              -->
  <!-- ============================================== -->
  <div id="state-pack-section" class="state-section pt-24 pb-8 px-4">
    <div id="viewport-frame-b" class="viewport-frame bg-stone-100 shadow-2xl rounded-xl border border-stone-300 relative" style="width: 100%; max-width: 1280px; height: 80vh;">

      <!-- Fond simule -->
      <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8">
        <div class="w-full max-w-4xl opacity-30">
          <div class="h-8 bg-stone-300 rounded mb-4 w-48"></div>
          <div class="h-4 bg-stone-200 rounded mb-2 w-64"></div>
          <div class="h-32 bg-stone-200 rounded mb-4"></div>
          <div class="h-48 bg-stone-200 rounded mb-4"></div>
          <div class="h-64 bg-stone-200 rounded"></div>
        </div>
      </div>

      <!-- OVERLAY -->
      <div class="overlay absolute inset-0 z-40 flex items-center justify-center p-4">
        <div class="modal-enter bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">

          <!-- Drag handle -->
          <div class="mobile-handle hidden justify-center pt-2 pb-1">
            <div class="w-10 h-1 rounded-full bg-stone-300"></div>
          </div>

          <!-- Header -->
          <div class="modal-header px-5 sm:px-6 pt-5 sm:pt-6 pb-4 border-b border-stone-100">
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-accent/10 flex items-center justify-center shrink-0">
                  <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
                </div>
                <div>
                  <h2 class="text-base sm:text-lg font-bold text-stone-900 font-outfit">Pack recommande</h2>
                  <p class="text-xs text-stone-500 mt-0.5">Etape 4 — Periode conditionnelle</p>
                </div>
              </div>
              <button class="p-1.5 rounded-lg hover:bg-stone-100 text-stone-400 -mt-1 -mr-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>

          <!-- Corps -->
          <div class="modal-body px-5 sm:px-6 py-4 space-y-4">

            <!-- Pack info card -->
            <div class="rounded-lg bg-accent/5 border border-accent/20 p-3 sm:p-4">
              <div class="flex items-center gap-2 mb-2">
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-indigo-100 text-indigo-700">Universal</span>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-sky-100 text-sky-700">Legal</span>
              </div>
              <h3 class="text-sm font-semibold text-stone-900 mb-1">Pack Universal</h3>
              <p class="text-xs text-stone-500">Conditions standard applicables a toutes les transactions residentielles au Nouveau-Brunswick.</p>
              <div class="flex items-center gap-3 mt-2 pt-2 border-t border-accent/10">
                <span class="text-xs text-stone-500 flex items-center gap-1">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                  {N} conditions
                </span>
                <span class="text-xs text-stone-500 flex items-center gap-1">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                  Profil : Residentiel, Urbain, Finance
                </span>
              </div>
            </div>

            <!-- Additif info -->
            <div class="flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-50 border border-emerald-200">
              <svg class="w-4 h-4 text-emerald-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span class="text-xs text-emerald-800"><strong>Mode additif</strong> — les conditions deja presentes ne seront pas dupliquees.</span>
            </div>

            <!-- Liste conditions du pack -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-xs font-semibold text-stone-600 uppercase tracking-wide">Conditions incluses</h3>
                <span class="text-xs text-stone-400" id="pack-count">{N} selectionnees</span>
              </div>
              <div class="space-y-1.5" id="pack-conditions">

                <!-- Condition 1: Bloquante — deja presente -->
                <div class="pack-condition-row excluded rounded-lg border border-stone-200 bg-stone-50 p-2.5 flex items-center gap-2.5">
                  <input type="checkbox" disabled checked class="w-4 h-4 rounded border-stone-300 text-stone-300 shrink-0 cursor-not-allowed">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-1.5 flex-wrap">
                      <span class="condition-name text-xs text-stone-400">Inspection en batiment</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-100 text-red-700">Bloquante</span>
                    </div>
                  </div>
                  <span class="text-[10px] text-stone-400 italic shrink-0">Deja presente</span>
                </div>

                <!-- Condition 2: Bloquante — deja presente -->
                <div class="pack-condition-row excluded rounded-lg border border-stone-200 bg-stone-50 p-2.5 flex items-center gap-2.5">
                  <input type="checkbox" disabled checked class="w-4 h-4 rounded border-stone-300 text-stone-300 shrink-0 cursor-not-allowed">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-1.5 flex-wrap">
                      <span class="condition-name text-xs text-stone-400">Financement approuve</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-100 text-red-700">Bloquante</span>
                    </div>
                  </div>
                  <span class="text-[10px] text-stone-400 italic shrink-0">Deja presente</span>
                </div>

                <!-- Condition 3: Requise — a ajouter -->
                <div class="pack-condition-row rounded-lg border border-stone-200 bg-white p-2.5 flex items-center gap-2.5" onclick="togglePackCondition(this)">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-primary/30 text-primary shrink-0 pointer-events-none">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-1.5 flex-wrap">
                      <span class="condition-name text-xs text-stone-800">Examen des declarations du vendeur (RPDS)</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-100 text-amber-700">Requise</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-sky-100 text-sky-700">Legal</span>
                    </div>
                  </div>
                  <span class="text-[10px] text-emerald-600 font-medium shrink-0">Nouvelle</span>
                </div>

                <!-- Condition 4: Requise — a ajouter -->
                <div class="pack-condition-row rounded-lg border border-stone-200 bg-white p-2.5 flex items-center gap-2.5" onclick="togglePackCondition(this)">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-primary/30 text-primary shrink-0 pointer-events-none">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-1.5 flex-wrap">
                      <span class="condition-name text-xs text-stone-800">Test d'eau potable</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-100 text-red-700">Bloquante</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-sky-100 text-sky-700">Industry</span>
                    </div>
                  </div>
                  <span class="text-[10px] text-emerald-600 font-medium shrink-0">Nouvelle</span>
                </div>

                <!-- Condition 5: Recommandee — a ajouter -->
                <div class="pack-condition-row rounded-lg border border-stone-200 bg-white p-2.5 flex items-center gap-2.5" onclick="togglePackCondition(this)">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-primary/30 text-primary shrink-0 pointer-events-none">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-1.5 flex-wrap">
                      <span class="condition-name text-xs text-stone-800">Verification du titre de propriete</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-100 text-amber-700">Requise</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-sky-100 text-sky-700">Legal</span>
                    </div>
                  </div>
                  <span class="text-[10px] text-emerald-600 font-medium shrink-0">Nouvelle</span>
                </div>

                <!-- Condition 6: Recommandee — a ajouter -->
                <div class="pack-condition-row rounded-lg border border-stone-200 bg-white p-2.5 flex items-center gap-2.5" onclick="togglePackCondition(this)">
                  <input type="checkbox" checked class="w-4 h-4 rounded border-primary/30 text-primary shrink-0 pointer-events-none">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-1.5 flex-wrap">
                      <span class="condition-name text-xs text-stone-800">Test de radon</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-stone-200 text-stone-600">Recommandee</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-sky-100 text-sky-700">Best practice</span>
                    </div>
                  </div>
                  <span class="text-[10px] text-emerald-600 font-medium shrink-0">Nouvelle</span>
                </div>

              </div>
            </div>

            <!-- Echeance par defaut -->
            <div class="rounded-lg border border-stone-200 bg-stone-50 px-3 py-2.5">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4 text-stone-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                <span class="text-xs text-stone-600">Echeances : alignees automatiquement sur l'echeance de l'etape (modifiables apres ajout)</span>
              </div>
            </div>

          </div>

          <!-- Footer -->
          <div class="px-5 sm:px-6 py-4 bg-stone-50 border-t border-stone-100 flex flex-col-reverse sm:flex-row items-stretch sm:items-center gap-2 sm:justify-end">
            <button class="px-4 py-2.5 rounded-lg border border-stone-200 text-stone-600 hover:bg-stone-100 text-sm font-medium text-center">
              Annuler
            </button>
            <button id="cta-pack" class="px-6 py-2.5 rounded-lg bg-accent hover:bg-accent/90 text-white text-sm font-semibold shadow-sm flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
              Charger {N} conditions
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- ETAT C: SUCCES — Pack charge                    -->
  <!-- ============================================== -->
  <div id="state-success-section" class="state-section pt-24 pb-8 px-4">
    <div id="viewport-frame-c" class="viewport-frame bg-stone-100 shadow-2xl rounded-xl border border-stone-300 relative" style="width: 100%; max-width: 1280px; height: 80vh;">

      <!-- Fond simule -->
      <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8">
        <div class="w-full max-w-4xl opacity-30">
          <div class="h-8 bg-stone-300 rounded mb-4 w-48"></div>
          <div class="h-4 bg-stone-200 rounded mb-2 w-64"></div>
          <div class="h-32 bg-stone-200 rounded mb-4"></div>
          <div class="h-48 bg-stone-200 rounded mb-4"></div>
          <div class="h-64 bg-stone-200 rounded"></div>
        </div>
      </div>

      <!-- OVERLAY -->
      <div class="overlay absolute inset-0 z-40 flex items-center justify-center p-4">
        <div class="modal-enter bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">

          <!-- Drag handle -->
          <div class="mobile-handle hidden justify-center pt-2 pb-1">
            <div class="w-10 h-1 rounded-full bg-stone-300"></div>
          </div>

          <!-- Success header -->
          <div class="modal-header px-5 sm:px-6 py-5 text-center">
            <div class="w-14 h-14 rounded-full bg-emerald-100 flex items-center justify-center mx-auto mb-3">
              <svg class="w-7 h-7 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            </div>
            <h2 class="text-base sm:text-lg font-bold text-stone-900 font-outfit">Pack charge !</h2>
            <p class="text-sm text-stone-500 mt-1">Universal — {N} conditions ajoutees</p>
          </div>

          <!-- Resume -->
          <div class="modal-body px-5 sm:px-6 pb-5 space-y-2">
            <!-- Ajoutees -->
            <div class="flex items-center gap-2 p-2.5 rounded-lg bg-emerald-50 border border-emerald-100">
              <svg class="w-4 h-4 text-emerald-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              <span class="text-xs text-emerald-800">{N} conditions ajoutees a l'etape 4</span>
            </div>
            <!-- Ignorees -->
            <div class="flex items-center gap-2 p-2.5 rounded-lg bg-stone-50 border border-stone-200">
              <svg class="w-4 h-4 text-stone-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636"/></svg>
              <span class="text-xs text-stone-600">{N} conditions ignorees (deja presentes)</span>
            </div>
            <!-- Detail niveau -->
            <div class="flex items-center gap-2 p-2.5 rounded-lg bg-primary/5 border border-primary/10">
              <svg class="w-4 h-4 text-primary shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
              <span class="text-xs text-primary">Repartition : {N} bloquantes, {N} requises, {N} recommandees</span>
            </div>
            <!-- Echeances -->
            <div class="flex items-center gap-2 p-2.5 rounded-lg bg-stone-50 border border-stone-200">
              <svg class="w-4 h-4 text-stone-500 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              <span class="text-xs text-stone-600">Echeances alignees sur l'etape — modifiables individuellement</span>
            </div>
          </div>

          <!-- CTA retour -->
          <div class="px-5 sm:px-6 py-4 bg-stone-50 border-t border-stone-100 text-center">
            <button class="px-6 py-2.5 rounded-lg bg-primary hover:bg-primary/90 text-white text-sm font-semibold shadow-sm">
              Retour a la transaction
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
    let selectedLevel = null;

    function selectLevel(card, level) {
      document.querySelectorAll('#level-cards .level-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      selectedLevel = level;
      updateManualCta();
    }

    function updateManualCta() {
      const cta = document.getElementById('cta-manual');
      const name = document.getElementById('condition-name').value.trim();
      const valid = name.length > 0 && selectedLevel !== null;
      const enabledClass = 'px-6 py-2.5 rounded-lg bg-primary hover:bg-primary/90 text-white text-sm font-semibold shadow-sm flex items-center justify-center gap-2';
      const disabledClass = 'px-6 py-2.5 rounded-lg bg-stone-300 text-stone-500 text-sm font-semibold shadow-sm flex items-center justify-center gap-2 cursor-not-allowed';
      cta.disabled = !valid;
      cta.className = valid ? enabledClass : disabledClass;
      cta.title = valid ? '' : 'Nom et niveau requis';
    }

    function togglePackCondition(row) {
      if (row.classList.contains('excluded')) return;
      const checkbox = row.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
      row.style.opacity = checkbox.checked ? '1' : '0.4';
      row.querySelector('.condition-name').style.textDecoration = checkbox.checked ? 'none' : 'line-through';
      const label = row.querySelector('.text-emerald-600');
      if (label) label.style.display = checkbox.checked ? '' : 'none';
    }

    function showState(state) {
      document.querySelectorAll('.state-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.state-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('state-' + state + '-section').classList.add('active');
      document.getElementById('state-' + state).classList.add('active');
    }

    function setViewport(mode) {
      const frames = document.querySelectorAll('.viewport-frame');
      document.querySelectorAll('.viewport-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('btn-' + mode).classList.add('active');
      frames.forEach(frame => {
        if (mode === 'mobile') { frame.style.maxWidth = '375px'; frame.classList.add('mobile-mode'); }
        else if (mode === 'tablet') { frame.style.maxWidth = '768px'; frame.classList.remove('mobile-mode'); }
        else { frame.style.maxWidth = '1280px'; frame.classList.remove('mobile-mode'); }
      });
    }
  </script>

</body>
</html>
