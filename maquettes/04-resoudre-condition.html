<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maquette 04 — Resoudre une condition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwindcss.config = {
      theme: {
        extend: {
          colors: { primary: '#1e3a5f', accent: '#e07a2f' },
          fontFamily: { outfit: ['Outfit', 'system-ui', 'sans-serif'] },
        },
      },
    }
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    .viewport-btn.active { background: #1e3a5f; color: white; }
    .viewport-frame { transition: width 0.4s ease, max-width 0.4s ease; margin: 0 auto; overflow: hidden; }
    .overlay {
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
      overflow-y: auto;
    }
    .modal-enter {
      animation: modalIn 0.2s ease-out;
      display: flex;
      flex-direction: column;
      max-height: calc(100% - 2rem);
    }
    .modal-body {
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    @keyframes modalIn { from { opacity: 0; transform: scale(0.95) translateY(8px); } to { opacity: 1; transform: scale(1) translateY(0); } }

    /* Mobile bottom-sheet */
    .mobile-mode { overflow-y: auto !important; }
    .mobile-mode .overlay {
      align-items: flex-end;
      padding: 0;
    }
    .mobile-mode .modal-enter {
      max-width: 100%;
      border-radius: 1rem 1rem 0 0;
      max-height: 92%;
      animation: sheetUp 0.25s ease-out;
    }
    .mobile-mode .mobile-handle { display: flex; }
    .mobile-mode .modal-header { padding-top: 0.75rem; }
    @keyframes sheetUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }

    /* State toggle */
    .state-section { display: none; }
    .state-section.active { display: block; }
    .state-btn.active { background: #1e3a5f; color: white; }

    /* Resolution card selection */
    .resolution-card { cursor: pointer; transition: all 0.15s ease; }
    .resolution-card:hover { border-color: #1e3a5f; }
    .resolution-card.selected { border-color: #1e3a5f; background: rgba(30,58,95,0.05); box-shadow: 0 0 0 2px rgba(30,58,95,0.15); }
    .resolution-card .radio-dot { display: none; }
    .resolution-card.selected .radio-dot { display: block; }
    .resolution-card .radio-empty { display: block; }
    .resolution-card.selected .radio-empty { display: none; }

    /* Upload zone */
    .upload-zone { border: 2px dashed #d6d3d1; transition: all 0.15s ease; }
    .upload-zone:hover { border-color: #1e3a5f; background: rgba(30,58,95,0.02); }

    /* D41 escape */
    .d41-escape { display: none; }
    .d41-escape.visible { display: block; }

    /* Disabled resolution card */
    .resolution-card.disabled {
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
      background: #fafaf9;
    }

    /* Note required indicator */
    .note-required-hint { display: none; }
    .note-required-hint.visible { display: flex; }
  </style>
</head>
<body class="bg-stone-200 min-h-screen">

  <!-- VIEWPORT SWITCHER -->
  <div class="fixed top-0 left-0 right-0 bg-stone-800 text-white z-[100] shadow-lg">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-sm font-bold font-outfit">MAQUETTE 04</span>
        <span class="text-xs text-stone-400">Resoudre une condition</span>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="setViewport('mobile')" id="btn-mobile" class="viewport-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-stone-700 hover:bg-stone-600 transition-colors">Mobile (375px)</button>
        <button onclick="setViewport('tablet')" id="btn-tablet" class="viewport-btn px-3 py-1.5 rounded-lg text-xs font-medium bg-stone-700 hover:bg-stone-600 transition-colors">Tablette (768px)</button>
        <button onclick="setViewport('desktop')" id="btn-desktop" class="viewport-btn active px-3 py-1.5 rounded-lg text-xs font-medium bg-stone-700 hover:bg-stone-600 transition-colors">Desktop (1280px)</button>
      </div>
      <div class="text-xs text-stone-400">Bouton "Resoudre" sur condition</div>
    </div>
  </div>

  <!-- STATE SWITCHER -->
  <div class="fixed top-[52px] left-0 right-0 bg-stone-700 text-white z-[99] border-t border-stone-600">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center gap-3">
      <span class="text-xs text-stone-400 font-medium">CAS :</span>
      <button onclick="showState('blocking')" id="state-blocking" class="state-btn active px-3 py-1 rounded-md text-xs font-medium bg-stone-600 hover:bg-stone-500 transition-colors">A — Bloquante</button>
      <button onclick="showState('required')" id="state-required" class="state-btn px-3 py-1 rounded-md text-xs font-medium bg-stone-600 hover:bg-stone-500 transition-colors">B — Requise</button>
      <button onclick="showState('recommended')" id="state-recommended" class="state-btn px-3 py-1 rounded-md text-xs font-medium bg-stone-600 hover:bg-stone-500 transition-colors">C — Recommandee</button>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- CAS A: CONDITION BLOQUANTE                      -->
  <!-- ============================================== -->
  <div id="state-blocking-section" class="state-section active pt-24 pb-8 px-4">
    <div id="viewport-frame-a" class="viewport-frame bg-stone-100 shadow-2xl rounded-xl border border-stone-300 relative" style="width: 100%; max-width: 1280px; height: 80vh;">

      <!-- Fond simule -->
      <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8">
        <div class="w-full max-w-4xl opacity-30">
          <div class="h-8 bg-stone-300 rounded mb-4 w-48"></div>
          <div class="h-4 bg-stone-200 rounded mb-2 w-64"></div>
          <div class="h-32 bg-stone-200 rounded mb-4"></div>
          <div class="h-48 bg-stone-200 rounded mb-4"></div>
          <div class="h-64 bg-stone-200 rounded"></div>
        </div>
      </div>

      <!-- OVERLAY -->
      <div class="overlay absolute inset-0 z-40 flex items-center justify-center p-4">
        <div class="modal-enter bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">

          <!-- Drag handle -->
          <div class="mobile-handle hidden justify-center pt-2 pb-1">
            <div class="w-10 h-1 rounded-full bg-stone-300"></div>
          </div>

          <!-- Header -->
          <div class="modal-header px-5 sm:px-6 pt-5 sm:pt-6 pb-4 border-b border-stone-100">
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center shrink-0">
                  <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                </div>
                <div>
                  <h2 class="text-base sm:text-lg font-bold text-stone-900 font-outfit">Resoudre la condition</h2>
                  <p class="text-xs text-stone-500 mt-0.5">Etape 4 — Periode conditionnelle</p>
                </div>
              </div>
              <button class="p-1.5 rounded-lg hover:bg-stone-100 text-stone-400 -mt-1 -mr-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>

          <!-- Corps -->
          <div class="modal-body px-5 sm:px-6 py-4 space-y-4">

            <!-- Condition info card -->
            <div class="rounded-lg bg-stone-50 border border-stone-200 p-3 sm:p-4">
              <div class="flex items-center gap-2 flex-wrap mb-2">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-red-100 text-red-700">Bloquante</span>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-700">Universal</span>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-sky-100 text-sky-700">Legal</span>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-stone-100 text-stone-400">Generee</span>
              </div>
              <h3 class="text-sm font-semibold text-stone-900 mb-1">Approbation du financement hypothecaire</h3>
              <div class="flex items-center gap-3 text-xs text-stone-500">
                <span class="flex items-center gap-1">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  Echeance : 18 fev. 2026
                </span>
                <span class="flex items-center gap-1 text-red-500 font-medium">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  Dans 12 jours
                </span>
              </div>
            </div>

            <!-- Type de resolution -->
            <div>
              <h3 class="text-xs font-semibold text-stone-600 mb-2 uppercase tracking-wide">Type de resolution</h3>
              <div class="space-y-2" id="blocking-resolution-cards">
                <!-- Completee -->
                <div class="resolution-card selected rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectResolution('blocking', this, 'completed')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-stone-900">Completee</span>
                    <p class="text-xs text-stone-500 mt-0.5">La condition est remplie avec succes</p>
                  </div>
                </div>
                <!-- Renoncee -->
                <div class="resolution-card rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectResolution('blocking', this, 'waived')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-stone-900">Renoncee</span>
                    <p class="text-xs text-stone-500 mt-0.5">L'acheteur renonce volontairement a cette condition</p>
                  </div>
                </div>
                <!-- Non applicable -->
                <div class="resolution-card rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectResolution('blocking', this, 'not_applicable')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-stone-900">Non applicable</span>
                    <p class="text-xs text-stone-500 mt-0.5">Cette condition ne s'applique pas a cette transaction</p>
                  </div>
                </div>
                <!-- Passee avec risque — INTERDIT pour Bloquante (contrainte DB) -->
                <div class="resolution-card disabled rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-200"></div>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="text-sm font-medium text-stone-400 line-through">Passee avec risque</span>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-100 text-red-600">Non disponible</span>
                    </div>
                    <p class="text-xs text-stone-400 mt-0.5">Contrainte DB : impossible pour les conditions bloquantes</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Upload piece justificative -->
            <div id="upload-zone-blocking">
              <label class="block text-xs font-semibold text-stone-600 mb-2 uppercase tracking-wide">Piece justificative (optionnel)</label>
              <!-- Empty state -->
              <div id="upload-empty-blocking" class="upload-zone rounded-lg p-4 text-center cursor-pointer" onclick="simulateFileAttach('blocking')">
                <svg class="w-8 h-8 text-stone-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                <p class="text-xs text-stone-500">Glissez un fichier ou <button type="button" class="text-primary font-medium hover:underline">parcourez</button></p>
                <p class="text-xs text-stone-400 mt-1">PDF, JPG, PNG — max 10 Mo</p>
              </div>
              <!-- Attached state (hidden by default) -->
              <div id="upload-attached-blocking" class="hidden rounded-lg border border-green-200 bg-green-50 p-3 flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center shrink-0">
                  <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-stone-900 truncate">lettre-engagement-TD.pdf</p>
                  <p class="text-xs text-stone-400">245 Ko</p>
                </div>
                <button type="button" onclick="simulateFileRemove('blocking')" class="p-1 rounded hover:bg-red-100 text-stone-400 hover:text-red-500 transition-colors" title="Retirer le fichier">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
            </div>

            <!-- D41: Escape sans preuve (visible quand pas de fichier joint) -->
            <div id="d41-blocking" class="d41-escape visible">
              <div class="rounded-lg bg-amber-50 border border-amber-200 p-3">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
                  <span class="text-xs font-semibold text-amber-800">Resolution sans piece justificative</span>
                </div>
                <p class="text-xs text-amber-700 mb-2">Pour resoudre une condition bloquante sans preuve, veuillez fournir une justification detaillee (minimum 10 caracteres).</p>
                <textarea id="d41-textarea" rows="2" placeholder="Justification obligatoire (min. 10 caracteres)..." class="w-full px-3 py-2 text-sm rounded-lg border border-amber-200 focus:outline-none focus:ring-2 focus:ring-amber-300/50 resize-none bg-white" minlength="10" oninput="updateBlockingCta()"></textarea>
                <p class="text-xs text-amber-500 mt-1 flex items-center gap-1">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  Regie D41 — minimum 10 caracteres requis
                </p>
                <label class="flex items-start gap-2 mt-2 cursor-pointer">
                  <input type="checkbox" id="d41-checkbox" class="mt-0.5 w-4 h-4 rounded border-amber-300 text-primary focus:ring-primary/20" onchange="updateBlockingCta()">
                  <span class="text-xs text-amber-800 font-medium">Je confirme vouloir resoudre cette condition bloquante sans piece justificative</span>
                </label>
              </div>
            </div>

            <!-- Note optionnelle -->
            <div>
              <label class="block text-xs font-medium text-stone-600 mb-1">Note (optionnel)</label>
              <textarea rows="2" placeholder="Ex : Lettre d'engagement recue de la TD..." class="w-full px-3 py-2 text-sm rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-primary/20 resize-none"></textarea>
            </div>

          </div>

          <!-- Footer -->
          <div class="px-5 sm:px-6 py-4 bg-stone-50 border-t border-stone-100 flex flex-col-reverse sm:flex-row items-stretch sm:items-center gap-2 sm:justify-end">
            <button class="px-4 py-2.5 rounded-lg border border-stone-200 text-stone-600 hover:bg-stone-100 text-sm font-medium text-center">
              Annuler
            </button>
            <button id="cta-blocking" disabled class="px-6 py-2.5 rounded-lg bg-stone-300 text-stone-500 text-sm font-semibold shadow-sm flex items-center justify-center gap-2 cursor-not-allowed" title="Justification D41 requise sans preuve">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              Confirmer la resolution
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- CAS B: CONDITION REQUISE                        -->
  <!-- ============================================== -->
  <div id="state-required-section" class="state-section pt-24 pb-8 px-4">
    <div id="viewport-frame-b" class="viewport-frame bg-stone-100 shadow-2xl rounded-xl border border-stone-300 relative" style="width: 100%; max-width: 1280px; height: 80vh;">

      <!-- Fond simule -->
      <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8">
        <div class="w-full max-w-4xl opacity-30">
          <div class="h-8 bg-stone-300 rounded mb-4 w-48"></div>
          <div class="h-4 bg-stone-200 rounded mb-2 w-64"></div>
          <div class="h-32 bg-stone-200 rounded mb-4"></div>
          <div class="h-48 bg-stone-200 rounded mb-4"></div>
          <div class="h-64 bg-stone-200 rounded"></div>
        </div>
      </div>

      <!-- OVERLAY -->
      <div class="overlay absolute inset-0 z-40 flex items-center justify-center p-4">
        <div class="modal-enter bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">

          <!-- Drag handle -->
          <div class="mobile-handle hidden justify-center pt-2 pb-1">
            <div class="w-10 h-1 rounded-full bg-stone-300"></div>
          </div>

          <!-- Header -->
          <div class="modal-header px-5 sm:px-6 pt-5 sm:pt-6 pb-4 border-b border-stone-100">
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center shrink-0">
                  <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
                </div>
                <div>
                  <h2 class="text-base sm:text-lg font-bold text-stone-900 font-outfit">Resoudre la condition</h2>
                  <p class="text-xs text-stone-500 mt-0.5">Etape 4 — Periode conditionnelle</p>
                </div>
              </div>
              <button class="p-1.5 rounded-lg hover:bg-stone-100 text-stone-400 -mt-1 -mr-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>

          <!-- Corps -->
          <div class="modal-body px-5 sm:px-6 py-4 space-y-4">

            <!-- Condition info card -->
            <div class="rounded-lg bg-stone-50 border border-stone-200 p-3 sm:p-4">
              <div class="flex items-center gap-2 flex-wrap mb-2">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">Requise</span>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-700">Rural NB</span>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-sky-100 text-sky-700">Industry</span>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-stone-100 text-stone-400">Generee</span>
              </div>
              <h3 class="text-sm font-semibold text-stone-900 mb-1">Certificat de localisation</h3>
              <div class="flex items-center gap-3 text-xs text-stone-500">
                <span class="flex items-center gap-1">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  Echeance : 20 fev. 2026
                </span>
                <span class="flex items-center gap-1 text-amber-500 font-medium">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  Dans 14 jours
                </span>
              </div>
            </div>

            <!-- Type de resolution — 4 types pour Requise -->
            <div>
              <h3 class="text-xs font-semibold text-stone-600 mb-2 uppercase tracking-wide">Type de resolution</h3>
              <div class="space-y-2" id="required-resolution-cards">
                <!-- Completee -->
                <div class="resolution-card selected rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectResolution('required', this, 'completed')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-stone-900">Completee</span>
                    <p class="text-xs text-stone-500 mt-0.5">La condition est remplie avec succes</p>
                  </div>
                </div>
                <!-- Renoncee -->
                <div class="resolution-card rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectResolution('required', this, 'waived')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-stone-900">Renoncee</span>
                    <p class="text-xs text-stone-500 mt-0.5">L'acheteur renonce volontairement a cette condition</p>
                    <p class="text-xs text-amber-600 mt-0.5 italic">Note obligatoire pour justifier la renonciation</p>
                  </div>
                </div>
                <!-- Non applicable -->
                <div class="resolution-card rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectResolution('required', this, 'not_applicable')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-stone-900">Non applicable</span>
                    <p class="text-xs text-stone-500 mt-0.5">Cette condition ne s'applique pas a cette transaction</p>
                    <p class="text-xs text-amber-600 mt-0.5 italic">Note obligatoire pour justifier</p>
                  </div>
                </div>
                <!-- Passee avec risque — DISPONIBLE pour Requise -->
                <div class="resolution-card rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectResolution('required', this, 'skipped_with_risk')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-stone-900">Passee avec risque</span>
                    <p class="text-xs text-stone-500 mt-0.5">Avancer malgre la condition non remplie — un avertissement sera enregistre</p>
                    <p class="text-xs text-red-500 mt-0.5 italic">Note obligatoire — le risque sera consigne</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Upload piece justificative -->
            <div>
              <label class="block text-xs font-semibold text-stone-600 mb-2 uppercase tracking-wide">Piece justificative (optionnel)</label>
              <div class="upload-zone rounded-lg p-4 text-center">
                <svg class="w-8 h-8 text-stone-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                <p class="text-xs text-stone-500">Glissez un fichier ou <button class="text-primary font-medium hover:underline">parcourez</button></p>
                <p class="text-xs text-stone-400 mt-1">PDF, JPG, PNG — max 10 Mo</p>
              </div>
            </div>

            <!-- Note -->
            <div>
              <label class="block text-xs font-medium text-stone-600 mb-1">
                Note <span class="text-stone-400" id="note-required-label-b">(optionnel)</span>
              </label>
              <textarea id="note-required-textarea" rows="2" placeholder="Ex : Certificat recu du bureau de l'arpenteur..." class="w-full px-3 py-2 text-sm rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-primary/20 resize-none" oninput="updateRequiredCta()"></textarea>
              <!-- Hint note obligatoire (hidden by default, shown when waived/not_applicable/skipped) -->
              <div id="note-required-hint" class="note-required-hint items-center gap-1 mt-1 text-xs text-amber-600">
                <svg class="w-3 h-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
                Note obligatoire pour ce type de resolution
              </div>
            </div>

          </div>

          <!-- Footer -->
          <div class="px-5 sm:px-6 py-4 bg-stone-50 border-t border-stone-100 flex flex-col-reverse sm:flex-row items-stretch sm:items-center gap-2 sm:justify-end">
            <button class="px-4 py-2.5 rounded-lg border border-stone-200 text-stone-600 hover:bg-stone-100 text-sm font-medium text-center">
              Annuler
            </button>
            <button id="cta-required" class="px-6 py-2.5 rounded-lg bg-primary hover:bg-primary/90 text-white text-sm font-semibold shadow-sm flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              Confirmer la resolution
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ============================================== -->
  <!-- CAS C: CONDITION RECOMMANDEE                    -->
  <!-- ============================================== -->
  <div id="state-recommended-section" class="state-section pt-24 pb-8 px-4">
    <div id="viewport-frame-c" class="viewport-frame bg-stone-100 shadow-2xl rounded-xl border border-stone-300 relative" style="width: 100%; max-width: 1280px; height: 80vh;">

      <!-- Fond simule -->
      <div class="absolute inset-0 flex items-center justify-center p-4 sm:p-8">
        <div class="w-full max-w-4xl opacity-30">
          <div class="h-8 bg-stone-300 rounded mb-4 w-48"></div>
          <div class="h-4 bg-stone-200 rounded mb-2 w-64"></div>
          <div class="h-32 bg-stone-200 rounded mb-4"></div>
          <div class="h-48 bg-stone-200 rounded mb-4"></div>
          <div class="h-64 bg-stone-200 rounded"></div>
        </div>
      </div>

      <!-- OVERLAY -->
      <div class="overlay absolute inset-0 z-40 flex items-center justify-center p-4">
        <div class="modal-enter bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">

          <!-- Drag handle -->
          <div class="mobile-handle hidden justify-center pt-2 pb-1">
            <div class="w-10 h-1 rounded-full bg-stone-300"></div>
          </div>

          <!-- Header -->
          <div class="modal-header px-5 sm:px-6 pt-5 sm:pt-6 pb-4 border-b border-stone-100">
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center shrink-0">
                  <svg class="w-5 h-5 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <div>
                  <h2 class="text-base sm:text-lg font-bold text-stone-900 font-outfit">Resoudre la condition</h2>
                  <p class="text-xs text-stone-500 mt-0.5">Etape 4 — Periode conditionnelle</p>
                </div>
              </div>
              <button class="p-1.5 rounded-lg hover:bg-stone-100 text-stone-400 -mt-1 -mr-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>

          <!-- Corps -->
          <div class="modal-body px-5 sm:px-6 py-4 space-y-4">

            <!-- Condition info card -->
            <div class="rounded-lg bg-stone-50 border border-stone-200 p-3 sm:p-4">
              <div class="flex items-center gap-2 flex-wrap mb-2">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold bg-stone-200 text-stone-600">Recommandee</span>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-700">Rural NB</span>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-sky-100 text-sky-700">Best practice</span>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-stone-100 text-stone-400">Generee</span>
              </div>
              <h3 class="text-sm font-semibold text-stone-900 mb-1">Test de radon</h3>
              <div class="flex items-center gap-3 text-xs text-stone-500">
                <span class="flex items-center gap-1">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  Echeance : 25 fev. 2026
                </span>
              </div>
              <!-- Info auto-archivage -->
              <div class="mt-2 pt-2 border-t border-stone-200">
                <p class="text-xs text-stone-400 italic flex items-center gap-1">
                  <svg class="w-3 h-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  Si non resolue, sera auto-archivee comme « non applicable » lors de la validation de l'etape
                </p>
              </div>
            </div>

            <!-- Hint quick-action -->
            <div class="rounded-lg bg-primary/5 border border-primary/10 px-3 py-2 flex items-start gap-2">
              <svg class="w-4 h-4 text-primary mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              <p class="text-xs text-primary/80">Astuce : les recommandees peuvent aussi se resoudre rapidement depuis la liste (toggle).</p>
            </div>

            <!-- Type de resolution — 4 types incluant skipped_with_risk -->
            <div>
              <h3 class="text-xs font-semibold text-stone-600 mb-2 uppercase tracking-wide">Type de resolution</h3>
              <div class="space-y-2" id="recommended-resolution-cards">
                <!-- Completee -->
                <div class="resolution-card selected rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectResolution('recommended', this, 'completed')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-stone-900">Completee</span>
                    <p class="text-xs text-stone-500 mt-0.5">La condition est remplie avec succes</p>
                  </div>
                </div>
                <!-- Renoncee -->
                <div class="resolution-card rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectResolution('recommended', this, 'waived')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-stone-900">Renoncee</span>
                    <p class="text-xs text-stone-500 mt-0.5">L'acheteur renonce volontairement a cette condition</p>
                  </div>
                </div>
                <!-- Non applicable -->
                <div class="resolution-card rounded-lg border-2 border-stone-200 p-3 flex items-start gap-3" onclick="selectResolution('recommended', this, 'not_applicable')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-stone-900">Non applicable</span>
                    <p class="text-xs text-stone-500 mt-0.5">Cette condition ne s'applique pas a cette transaction</p>
                  </div>
                </div>
                <!-- Passee avec risque — DISPONIBLE pour Recommandee -->
                <div class="resolution-card rounded-lg border-2 border-amber-200 p-3 flex items-start gap-3" onclick="selectResolution('recommended', this, 'skipped_with_risk')">
                  <div class="mt-0.5 shrink-0">
                    <div class="radio-dot w-4 h-4 rounded-full bg-primary flex items-center justify-center">
                      <div class="w-1.5 h-1.5 rounded-full bg-white"></div>
                    </div>
                    <div class="radio-empty w-4 h-4 rounded-full border-2 border-stone-300"></div>
                  </div>
                  <div>
                    <span class="text-sm font-medium text-amber-800">Passee avec risque</span>
                    <p class="text-xs text-stone-500 mt-0.5">Avancer malgre la condition non remplie — un avertissement sera enregistre</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Upload piece justificative -->
            <div>
              <label class="block text-xs font-semibold text-stone-600 mb-2 uppercase tracking-wide">Piece justificative (optionnel)</label>
              <div class="upload-zone rounded-lg p-4 text-center">
                <svg class="w-8 h-8 text-stone-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                <p class="text-xs text-stone-500">Glissez un fichier ou <button class="text-primary font-medium hover:underline">parcourez</button></p>
                <p class="text-xs text-stone-400 mt-1">PDF, JPG, PNG — max 10 Mo</p>
              </div>
            </div>

            <!-- Note optionnelle -->
            <div>
              <label class="block text-xs font-medium text-stone-600 mb-1">Note (optionnel)</label>
              <textarea rows="2" placeholder="Ex : Test effectue, resultats normaux..." class="w-full px-3 py-2 text-sm rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-primary/20 resize-none"></textarea>
            </div>

          </div>

          <!-- Footer -->
          <div class="px-5 sm:px-6 py-4 bg-stone-50 border-t border-stone-100 flex flex-col-reverse sm:flex-row items-stretch sm:items-center gap-2 sm:justify-end">
            <button class="px-4 py-2.5 rounded-lg border border-stone-200 text-stone-600 hover:bg-stone-100 text-sm font-medium text-center">
              Annuler
            </button>
            <button class="px-6 py-2.5 rounded-lg bg-primary hover:bg-primary/90 text-white text-sm font-semibold shadow-sm flex items-center justify-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
              Confirmer la resolution
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script>
    // Track selected resolution per group
    let selectedType = { blocking: 'completed', required: 'completed', recommended: 'completed' };
    let fileAttached = { blocking: false };

    function simulateFileAttach(group) {
      fileAttached[group] = true;
      document.getElementById('upload-empty-' + group).classList.add('hidden');
      document.getElementById('upload-attached-' + group).classList.remove('hidden');
      if (group === 'blocking') {
        document.getElementById('d41-blocking').classList.remove('visible');
        updateBlockingCta();
      }
    }

    function simulateFileRemove(group) {
      fileAttached[group] = false;
      document.getElementById('upload-empty-' + group).classList.remove('hidden');
      document.getElementById('upload-attached-' + group).classList.add('hidden');
      if (group === 'blocking') {
        document.getElementById('d41-blocking').classList.add('visible');
        updateBlockingCta();
      }
    }

    function selectResolution(group, card, type) {
      // Deselect all in group
      const container = document.getElementById(group + '-resolution-cards');
      container.querySelectorAll('.resolution-card:not(.disabled)').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      selectedType[group] = type;

      // D41: show escape for all valid blocking types (no proof scenario)
      // All 3 valid types need D41 when no file attached
      if (group === 'blocking') {
        const d41 = document.getElementById('d41-blocking');
        // completed, waived, not_applicable are all valid for blocking
        d41.classList.add('visible');
        updateBlockingCta();
      }

      // Required: show/hide note-required hint
      if (group === 'required') {
        const hint = document.getElementById('note-required-hint');
        const label = document.getElementById('note-required-label-b');
        if (type === 'waived' || type === 'not_applicable' || type === 'skipped_with_risk') {
          hint.classList.add('visible');
          label.textContent = '(obligatoire)';
          label.classList.remove('text-stone-400');
          label.classList.add('text-red-500', 'font-semibold');
        } else {
          hint.classList.remove('visible');
          label.textContent = '(optionnel)';
          label.classList.add('text-stone-400');
          label.classList.remove('text-red-500', 'font-semibold');
        }
        updateRequiredCta();
      }
    }

    function updateBlockingCta() {
      const cta = document.getElementById('cta-blocking');
      const d41 = document.getElementById('d41-blocking');
      const enabledClass = 'px-6 py-2.5 rounded-lg bg-primary hover:bg-primary/90 text-white text-sm font-semibold shadow-sm flex items-center justify-center gap-2';
      const disabledClass = 'px-6 py-2.5 rounded-lg bg-stone-300 text-stone-500 text-sm font-semibold shadow-sm flex items-center justify-center gap-2 cursor-not-allowed';

      if (fileAttached.blocking) {
        // File attached → no D41 gating, CTA enabled
        cta.disabled = false;
        cta.className = enabledClass;
        cta.title = '';
      } else if (d41.classList.contains('visible')) {
        // No file → D41 gating: textarea >= 10 chars + checkbox
        const text = document.getElementById('d41-textarea').value.trim();
        const checked = document.getElementById('d41-checkbox').checked;
        const valid = text.length >= 10 && checked;
        cta.disabled = !valid;
        cta.className = valid ? enabledClass : disabledClass;
        cta.title = valid ? '' : 'Justification D41 requise sans preuve';
      } else {
        cta.disabled = false;
        cta.className = enabledClass;
        cta.title = '';
      }
    }

    function updateRequiredCta() {
      const cta = document.getElementById('cta-required');
      const type = selectedType.required;
      const needsNote = (type === 'waived' || type === 'not_applicable' || type === 'skipped_with_risk');
      if (needsNote) {
        const note = document.getElementById('note-required-textarea').value.trim();
        const valid = note.length > 0;
        cta.disabled = !valid;
        cta.className = valid
          ? 'px-6 py-2.5 rounded-lg bg-primary hover:bg-primary/90 text-white text-sm font-semibold shadow-sm flex items-center justify-center gap-2'
          : 'px-6 py-2.5 rounded-lg bg-stone-300 text-stone-500 text-sm font-semibold shadow-sm flex items-center justify-center gap-2 cursor-not-allowed';
      } else {
        cta.disabled = false;
        cta.className = 'px-6 py-2.5 rounded-lg bg-primary hover:bg-primary/90 text-white text-sm font-semibold shadow-sm flex items-center justify-center gap-2';
      }
    }

    function showState(state) {
      document.querySelectorAll('.state-section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.state-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('state-' + state + '-section').classList.add('active');
      document.getElementById('state-' + state).classList.add('active');
    }

    function setViewport(mode) {
      const frames = document.querySelectorAll('.viewport-frame');
      document.querySelectorAll('.viewport-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('btn-' + mode).classList.add('active');
      frames.forEach(frame => {
        if (mode === 'mobile') { frame.style.maxWidth = '375px'; frame.classList.add('mobile-mode'); }
        else if (mode === 'tablet') { frame.style.maxWidth = '768px'; frame.classList.remove('mobile-mode'); }
        else { frame.style.maxWidth = '1280px'; frame.classList.remove('mobile-mode'); }
      });
    }
  </script>

</body>
</html>
