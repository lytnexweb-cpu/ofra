# Audit Général Minutieux — Projet Ofra

**Date** : 2026-02-17
**Auditeurs** : Winston (Backend), Sally (Frontend), Murat (Tests), Paige (Docs)
**Méthode** : 4 audits parallèles exhaustifs, chaque agent a lu l'ensemble de son périmètre

---

## Résumé Exécutif

| Sévérité | Backend | Frontend | Tests | Docs | **TOTAL** |
|----------|---------|----------|-------|------|-----------|
| **P0 Critical** | 1 | 1 | 3 | 2 | **7** |
| **P1 High** | 7 | 9 | 10 | 8 | **34** |
| **P2 Medium** | 28 | 28 | 3 | 9 | **68** |
| **P3 Low** | 12 | 17 | 2 | 9 | **40** |
| **TOTAL** | **48** | **55** | **18** | **28** | **149** |

### Top 10 — Actions Immédiates

| # | Sévérité | Domaine | Problème | Effort |
|---|----------|---------|----------|--------|
| 1 | **P0** | Sécurité | Path traversal sur `GET /api/uploads/:filename` — `params.filename` non sanitisé | 5 min |
| 2 | **P0** | Conformité | FINTRAC spec violée : `onStepEnter` skip quand `autoConditionsEnabled=false` alors que FINTRAC doit TOUJOURS être créé | 5 min |
| 3 | **P0** | Frontend | `alert()` dans OffersSection (4x) et OffersPanel (1x) — inaccessible, bloquant | 15 min |
| 4 | **P0** | Tests | Zéro tests pour FINTRAC (module légal critique) | 2h |
| 5 | **P1** | Sécurité | Pas de CSRF protection visible (sessions cookie sans Shield middleware) | 30 min |
| 6 | **P1** | Data integrity | `OfferService.acceptOffer` et `WorkflowEngine.advanceStep` sans `db.transaction()` — corruption possible | 1h |
| 7 | **P1** | Frontend | Pas de `ErrorBoundary` — crash = écran blanc | 15 min |
| 8 | **P1** | Frontend | LoginPage `<label>` non liés aux `<input>` — WCAG A failure | 5 min |
| 9 | **P1** | Frontend | Pas de route 404 / catch-all — URL inconnue = écran blanc | 10 min |
| 10 | **P1** | Docs | Collision D35/D36 — même numéro = 2 décisions différentes selon le document | 30 min |

---

## 1. AUDIT BACKEND (Winston)

### 1.1 Sécurité

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| BE-SEC-1 | **P0** | **Path traversal** : `params.filename` dans `app.makePath('storage/uploads', params.filename)` — un `../../../etc/passwd` passe | `routes.ts:15-19` |
| BE-SEC-2 | **P1** | **Pas de CSRF** : Session cookie-based sans Shield middleware sur les mutations | `routes.ts` (global) |
| BE-SEC-3 | **P1** | **FINTRAC bypass** : `onStepEnter` retourne early si `!autoConditionsEnabled` — viole la spec "ALWAYS created" | `fintrac_service.ts:108-114` |
| BE-SEC-4 | **P2** | Admin `deleteTask`/`updateTask` sans vérification d'authorship — tout admin modifie les tâches des autres | `admin_controller.ts:451,495` |
| BE-SEC-5 | **P2** | `resendVerification` accepte `request.input('email')` sans validator VineJS | `auth_controller.ts:392` |
| BE-SEC-6 | **P2** | Rate limiting absent sur `GET /api/plans` (public) | `routes.ts:26` |

### 1.2 Data Integrity

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| BE-INT-1 | **P1** | `acceptOffer` : 4 opérations DB séquentielles sans `db.transaction()` — corruption si crash mid-accept | `offer_service.ts:217-293` |
| BE-INT-2 | **P1** | `advanceStep` : 8+ opérations DB sans wrapping — step complétée mais `currentStepId` pas mis à jour si crash | `workflow_engine_service.ts:188-391` |
| BE-INT-3 | **P1** | `archiveConditionsOnStepChange` : boucle de saves individuels sans transaction — archivage partiel possible | `conditions_engine_service.ts:202-270` |
| BE-INT-4 | **P1** | `createFintracConditionForParty` : Condition + FintracRecord + Event sans wrapping | `fintrac_service.ts:325-396` |

### 1.3 Routes / Auth

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| BE-AUTH-1 | **P1** | Sub-resource routes (offers, conditions, fintrac, parties, docs) n'ont pas de `txPermission` middleware — ownership check interne seulement | `routes.ts:112-194` |
| BE-AUTH-2 | **P2** | `transactions_controller.destroy` utilise `findOrFail` + `canAccess` au lieu du pattern atomique `apply().firstOrFail()` — TOCTOU | `transactions_controller.ts:675-700` |

### 1.4 Performances / N+1

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| BE-PERF-1 | **P2** | `isAtOrPastFirmPending` : query DB par step dans une boucle (8 steps = 8 queries) | `fintrac_service.ts:64-83` |
| BE-PERF-2 | **P2** | `createConditionsFromProfile` : INSERT individuel par condition (52 templates = 104 queries) | `conditions_engine_service.ts:91-133` |
| BE-PERF-3 | **P2** | Admin `subscribers` : filtre `engagement` en mémoire APRÈS pagination — metadata incorrecte | `admin_controller.ts:119-124` |

### 1.5 Modèles / Validators

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| BE-MOD-1 | **P2** | `Offer` model : pas de `@belongsTo(() => Transaction)` malgré `transactionId` | `offer.ts` |
| BE-MOD-2 | **P2** | `Transaction.tags` : `prepare` hook (serialize) sans `consume` hook (deserialize) — tags revient en string au lieu d'array | `transaction.ts:102` |
| BE-VAL-1 | **P2** | Dates (`closingDate`, `expiryAt`, etc.) validées comme `vine.string()` sans format date — `"notadate"` passe | `transaction_validator.ts`, `offer_validator.ts` |
| BE-VAL-2 | **P2** | `offer_validator` : 6 champs validés mais jamais utilisés par le service (depositDeadline, inspectionRequired, etc.) | `offer_validator.ts` |

### 1.6 Migrations

| ID | Sév. | Problème |
|----|------|----------|
| BE-MIG-1 | **P2** | Timestamps dupliqués : `1774000000002` (2 migrations) et `1772000000009` (2 migrations) — ordre indéterminé |
| BE-MIG-2 | **P2** | Index manquants : `conditions.transaction_id`, `conditions.step_when_created`, `transaction_share_links.token`, `users.email_verification_token` |

### 1.7 Divers

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| BE-MISC-1 | **P2** | `console.warn` au lieu de `logger` dans `offer_service.ts` | `offer_service.ts:285` |
| BE-MISC-2 | **P2** | `error.messages` duck-type check au lieu de `instanceof E_VALIDATION_ERROR` — fragile | Multiple controllers |
| BE-MISC-3 | **P3** | `expireOffers()` existe mais n'est jamais appelé — offres expirées restent en status `received` | `offer_service.ts:378-395` |
| BE-MISC-4 | **P3** | Party name update ne met pas à jour la condition FINTRAC associée — titre condition stale | `transaction_parties_controller.ts:129` |

---

## 2. AUDIT FRONTEND (Sally)

### 2.1 Critique / Accessibilité

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| FE-A11Y-1 | **P0** | `alert()` utilisé dans OffersSection (4x) et OffersPanel (1x) — bloquant, inaccessible, `toast()` existe déjà | `OffersSection.tsx`, `OffersPanel.tsx` |
| FE-A11Y-2 | **P1** | LoginPage `<label>` sans `htmlFor`, `<input>` sans `id` — WCAG 2.1 Level A failure | `LoginPage.tsx` |
| FE-A11Y-3 | **P1** | `window.confirm()` pour logout-all — inaccessible, `ConfirmDialog` existe | `AccountPage.tsx` |
| FE-A11Y-4 | **P2** | AccountPage tabs sans `role="tablist"`/`role="tab"`/`aria-selected` | `AccountPage.tsx` |
| FE-A11Y-5 | **P2** | OnboardingPage `OptionCard`/`MultiOptionCard` sans ARIA radio/checkbox semantics | `OnboardingPage.tsx` |
| FE-A11Y-6 | **P2** | ConditionCard toggle = plain `div`, pas un bouton/checkbox — inaccessible au clavier | `ConditionCard.tsx` |
| FE-A11Y-7 | **P2** | LoginPage password toggle `tabIndex={-1}` — retiré de la navigation clavier | `LoginPage.tsx` |

### 2.2 Architecture / Robustesse

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| FE-ARCH-1 | **P1** | **Pas d'ErrorBoundary** — crash runtime = écran blanc | `App.tsx` / `router.tsx` |
| FE-ARCH-2 | **P1** | **Pas de route 404** / catch-all — URL inconnue = écran blanc | `router.tsx` |
| FE-ARCH-3 | **P1** | **Pas de code splitting** — tout le JS (admin + Recharts inclus) dans un bundle | `router.tsx` |
| FE-ARCH-4 | **P1** | `http.ts` : 4xx silencieusement ignorés (retournent `{success:false}`) — beaucoup de call sites ne vérifient pas | `http.ts` |
| FE-ARCH-5 | **P2** | `advance-check` query jamais invalidée après mutation de condition — état stale 10s | `ActionZone.tsx` |
| FE-ARCH-6 | **P2** | `staleTime: 0` sur TransactionDetailPage — refetch à chaque navigation = flicker | `TransactionDetailPage.tsx` |

### 2.3 i18n / Hardcoded Strings

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| FE-I18N-1 | **P1** | `'Acheteur → Vendeur'`/`'Vendeur → Acheteur'` hardcodé en français — EN users voient FR | `OffersPanel.tsx:52` |
| FE-I18N-2 | **P2** | `SOURCE_LABELS`/`PACK_LABELS` hardcodés en anglais — les clés i18n existent mais ne sont pas utilisées | `ConditionCard.tsx:58-73` |
| FE-I18N-3 | **P2** | `Intl.NumberFormat` locale inconsistante : `'fr-CA'` dans OffersPanel, `'en-CA'` dans OffersSection | Multiple fichiers |
| FE-I18N-4 | **P3** | Placeholder email FR-only `"vous@exemple.com"` | `LoginPage.tsx:158` |

### 2.4 TypeScript

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| FE-TS-1 | **P1** | `mutationFn: (data: any)` + `const payload: any = {}` — client update non typé | `ClientDetailsPage.tsx:57,97` |
| FE-TS-2 | **P2** | Core transaction fields typés `any` : `conditions`, `property`, `notes` | `transactions.api.ts` |
| FE-TS-3 | **P2** | `http.post/put/patch` acceptent `data?: any` — aucune sécurité de type sur les bodies | `http.ts` |
| FE-TS-4 | **P2** | Double `as any` cast pour extraire les offres | `OffersSection.tsx:60` |

### 2.5 Performance

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| FE-PERF-1 | **P2** | `formatCAD` = `new Intl.NumberFormat()` créé à chaque appel dans 7+ fichiers — coûteux | Multiple |
| FE-PERF-2 | **P2** | `getUrgencyScore` O(n×m) dans `useMemo` qui re-run à chaque refetch 30s | `TransactionsPage.tsx` |

### 2.6 Dead Code / Inconsistance

| ID | Sév. | Problème | Fichier |
|----|------|----------|---------|
| FE-DEAD-1 | **P2** | `membersOpen` state jamais set à `true` — MembersPanel ne peut jamais s'ouvrir depuis cette page | `TransactionDetailPage.tsx` |
| FE-DEAD-2 | **P2** | ClientsPage : aucun error state — query fail = grille vide sans message | `ClientsPage.tsx` |
| FE-DEAD-3 | **P2** | AccountPage : dark mode manquant (pas de `dark:` variants) | `AccountPage.tsx` |

---

## 3. AUDIT TESTS (Murat)

### 3.1 Couverture globale

| Métrique | Backend | Frontend |
|----------|---------|----------|
| Controllers avec tests | 12 / 23 (**52%**) | N/A |
| Services avec tests | 6 / 15 (**40%**) | N/A |
| Pages avec tests | N/A | 4 / 18 (**22%**) |
| Composants clés avec tests | N/A | ~30 / ~65 (**46%**) |
| E2E flows couverts | — | 3 / ~12 (**25%**) |

### 3.2 Gaps Critiques (P0)

| ID | Domaine | Gap |
|----|---------|-----|
| TEST-P0-1 | **FINTRAC** | Zéro tests pour `FintracService` + `FintracController`. Module légalement obligatoire entièrement non testé : `onStepEnter`, `onPartyAdded/Removed`, `complete`, `isCompliant` |
| TEST-P0-2 | **Plan Gating** | `PlanService.meetsMinimum()` zéro tests — bug ici = toutes les feature gates cassées silencieusement |
| TEST-P0-3 | **E2E Lifecycle** | Aucun test E2E pour le cycle complet : créer TX → condition → résoudre → avancer step. Le cœur du produit n'a pas de filet |

### 3.3 Gaps Importants (P1)

| ID | Domaine | Gap |
|----|---------|-----|
| TEST-P1-1 | Transaction Parties | 0 tests. Parties déclenchent FINTRAC hooks |
| TEST-P1-2 | Transaction Profiles | 0 tests. Profile drive la génération auto de conditions |
| TEST-P1-3 | Dashboard API | 0 tests backend. SQL complexe entièrement non testé |
| TEST-P1-4 | Admin endpoints | 0 tests. Inclut le guard admin-only |
| TEST-P1-5 | FintracComplianceModal | 0 tests frontend. Seul point d'entrée UX pour la conformité légale |
| TEST-P1-6 | ValidateStepModal | 0 tests. Modal clé pour l'avancement des étapes |
| TEST-P1-7 | CreateOfferModal/AcceptOfferModal | 0 tests. Chemin principal de saisie d'offres |
| TEST-P1-8 | LoginPage submit flow | Test existant ne teste PAS la soumission, l'appel API, ni les erreurs |
| TEST-P1-9 | ReminderService | 0 tests. Jobs schedulés avec logique métier (digests, deadlines, trial) |
| TEST-P1-10 | Tenant isolation conditions | Seulement 4 tests, pas de test multi-tenancy |

---

## 4. AUDIT DOCUMENTATION (Paige)

### 4.1 Critiques

| ID | Problème |
|----|----------|
| DOC-CRIT-1 | **Collision D35/D36** : PRD §4.1 dit D35="Historique drawer", D36="Archivage auto". Les fichiers decisions disent D35="Offer Intake", D36="Dashboard Agent". Même numéro = 2 significations |

### 4.2 Statuts incorrects dans les docs

| ID | Document | Marqué comme | Réalité |
|----|----------|--------------|---------|
| DOC-H-1 | PRD §9.0 Bloc 5 Legal | ❌ TODO (0%) | TermsPage.tsx + PrivacyPage.tsx existent et sont routées |
| DOC-H-2 | Session-log REPRENDRE ICI | M11 "⬜ À implémenter" | ✅ 100% conforme (commit 82ab396) |
| DOC-H-3 | Session-log REPRENDRE ICI | M12 "❓ À vérifier" | ✅ 100% conforme (commit 275cf25) |
| DOC-H-4 | Session-log arbre état | FINTRAC "À FAIRE" | ✅ Implémenté (commit dfadaee) |
| DOC-H-5 | project-context.md | Périmé (2026-02-11) | Manquent Bloc 8, M10/11/12, D53, auth redesign, admin/plans |
| DOC-H-6 | project-context.md | Emails 23/23 | Réel : 24 (trial_reminder_mail.ts manquant) |
| DOC-H-7 | email-notifications-spec | OfferExpiredMail spécifié | Jamais implémenté (remplacé par OfferWithdrawnMail sans maj spec) |

### 4.3 Dead code documenté mais pas supprimé

| Fichier | Remplacé par | Monté ? |
|---------|-------------|---------|
| `OffersSection.tsx` | `OffersPanel.tsx` | Non |
| `CounterOfferModal.tsx` (racine) | `transaction/CreateOfferModal.tsx` | Non |
| `CreateOfferModal.tsx` (racine) | `transaction/CreateOfferModal.tsx` | Non |
| `OffersSection.test.tsx` | — | Test d'un composant mort |

---

## Plan d'Action Recommandé

### Sprint Fix P0 (1-2h)

1. ✅ Sanitiser `params.filename` → `path.basename()` (5 min)
2. ✅ Retirer le guard `autoConditionsEnabled` dans `FintracService.onStepEnter` (5 min)
3. ✅ Remplacer `alert()` par `toast()` dans OffersSection + OffersPanel (15 min)
4. ✅ Ajouter `ErrorBoundary` root (15 min)
5. ✅ Fixer labels LoginPage (`htmlFor` + `id`) (5 min)
6. ✅ Ajouter route 404 catch-all (10 min)
7. ✅ Résoudre collision D35/D36 dans docs (30 min)

### Sprint Fix P1 Sécu/Intégrité (3-4h)

8. Activer Shield CSRF middleware
9. Wrapper `acceptOffer` + `advanceStep` dans `db.transaction()`
10. Ajouter code splitting (`React.lazy`) dans router.tsx
11. Créer `lib/format.ts` avec `formatCAD` locale-aware (remplace 7 copies)
12. Corriger i18n hardcodé dans OffersPanel (`getDirectionLabel`)

### Sprint Tests P0 (4-6h)

13. Tests FINTRAC : `fintrac.spec.ts` (8-10 tests fonctionnels)
14. Tests PlanService : `plan_service.spec.ts` (unit tests `meetsMinimum`)
15. E2E lifecycle : `transaction-lifecycle.spec.ts`

### Nettoyage Docs (1h)

16. Corriger REPRENDRE ICI : M11 ✅, M12 ✅, FINTRAC ✅
17. Mettre à jour PRD Bloc 5 Legal → ✅ DONE
18. Mettre à jour project-context.md (Bloc 8, emails 24, FINTRAC done)
19. Supprimer dead code (OffersSection, CounterOfferModal, CreateOfferModal racine)
20. Corriger spec emails : OfferExpiredMail → OfferWithdrawnMail

---

_Rapport généré le 2026-02-17 — Audit complet 4 axes par Winston, Sally, Murat et Paige_
